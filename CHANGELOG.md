# Changelog
Все заметные изменения в этом проекте будут документироваться в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.1.0/).

## [0.1.2] - 2025-10-03
### Added
- Новый устойчивый клиент WGDashboard (`app/wgd_api.py`):
  - Повторные попытки (retry) на 502/503/504/timeout с экспоненциальной задержкой.
  - Общий `httpx.AsyncClient` с keep-alive пулом соединений.
  - Лёгкий кэш с малым TTL для `get_configs()` и `get_peers()` (снижение нагрузки и ускорение).
  - Настраиваемое окно «онлайн» через `SET.active_window_sec` (по умолчанию 180 сек).
  - Универсальная загрузка peer-конфигов (поддерживает разные форки API, JSON/октет-стрим).

- Вебхук WGDashboard (`app/wgd_webhook.py`):
  - Приём POST `/wgd/webhook`.
  - Проверка `X-WGD-Secret` (берётся из `SET.wgd_webhook_secret` или `SET.webhook_secret`).

- Улучшенные полезные утилиты (`app/utils.py`):
  - `human_bytes`, `human_ago`, улучшенный `render_table`, генерация QR (`make_qr_png`).

### Changed
- Статистика и списки:
  - `app/handlers/stats.py`, `app/handlers/admin.py`, `app/handlers/user.py` — теперь опираются на нормализованный снапшот всех конфигов (учёт разных портов и форков WGDashboard).
  - Красивые таблицы (моноширинные), короткие поля статуса/рукопожатия.
  - Переписаны клавиатуры `app/keyboards.py` — логичная навигация, действия по пиру.

- Работа с пирами:
  - Карточка пира: повторная загрузка, скачивание `.conf`, QR, удаление, локальное переименование (если доступна `rename_peer_row`).
  - Создание пирa всегда в персональной конфигурации пользователя (имя `wg<tg_id>`), адрес и порт — детерминированы из `tg_id`.

- Безопасность:
  - Аккуратные сообщения об ошибках без утечки чувствительных данных.
  - Жёсткие проверки прав для админ-хэндлеров.
  - Поддержка отсутствия `app_prefix` в WGDashboard.

### Fixed
- Корректный парсинг RX/TX/Handshake для разных вариантов ключей полей от форков WGDashboard.
- Отображение активности даже при «рандомных» портах на разных конфигурациях.
- Грейс-обработка пустых/неполных ответов API (нет падений в хэндлерах).

### Performance
- Пул соединений httpx + кэширование быстрых запросов.
- Меньше сетевых походов в админских и пользовательских списках (используется единый снапшот).

### Developer Experience
- Читаемые исключения `WGDError` с минимумом лишних деталей.
- Комментарии и докстринги по основным публичным методам клиента.

## [0.1.1] - 2025-10-03
### Added
- Пользовательский раздел:
  - Персональные WG-конфигурации (`wg<tg_id>`) + автоматическое создание через `/api/addWireguardConfiguration`.
  - Создание пиров внутри своей конфигурации, скачивание `.conf` и QR, удаление, локальное переименование (ForceReply).
  - Экран «Мои подключения»: аккуратная таблица (RX/TX/последний HS/CFG/статус) + inline-кнопки действий.
  - Команда/кнопка «Статистика» — суммарный трафик и показатели по каждому пиру.
- Админ-раздел:
  - Общая статистика (число конфигураций, пиров, online/offline, суммарный RX/TX).
  - Просмотр всех конфигураций (число пиров, активных, трафик) + детальный список пиров с пагинацией.
- Безопасный UX:
  - Фолбэк-ответы: на любые другие команды — подсказка про `/start`/`/старт`.
  - На произвольные текстовые сообщения (например, «привет») — дружелюбный ответ с HTML-экранированием.
  - Фолбэк на не-текстовые сообщения — подсказка про `/start`.

### Changed
- `wgd_api.py`:
  - Поддержка `addWireguardConfiguration`/`deleteWireguardConfiguration`; метод `ensure_config(...)`.
  - Создание пира `add_peer_minimal(...)` с автоподбором `allowed_ip`.
  - Стабильная загрузка конфига: основной путь `GET /api/downloadPeer/<cfg>?id=<publicKey>` + запасные варианты; понимает и JSON-ответы, и octet-stream.
  - Нормализация/снимок (`snapshot()`, `totals()`) для агрегированной статистики; определение активности по последнему handshake.
  - Универсальные `create_peer(...)`, `get_peer_config(...)`, `delete_peer(...)` (принимают как id, так и publicKey).
- Хендлеры (`start.py`, `user.py`, `admin.py`):
  - Приведены к единообразному стилю, добавлены красивые inline-клавиатуры, таблицы, безопасные подсказки.

### Fixed
- Совместимость с различными форками WGDashboard 4.x (варианты полей: `id/peer_id/Id`, `publicKey/PublicKey` и т.д.).
- Устранены проблемы с пиннингом зависимостей (`pydantic`, `pydantic-settings`) и обработкой «лишних» env-переменных.

### Notes
- Переменные окружения:
  - `WGD_API_BASE`, `WGD_API_TOKEN`, `WGD_WEBHOOK_SECRET`, `DATABASE_PATH`.
  - `WGD_INTERFACE` теперь не обязателен: используется как fallback; для пользователей применяется персональная конфигурация `wg<tg_id>`.

## [0.1.0] - 2025-10-02
### Added
- Базовая структура бота (aiogram + FastAPI webhook), авторизация webhook, первичный функционал создания/удаления пиров.
